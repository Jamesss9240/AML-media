<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="css/main.css" />
  </head>

  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AML Library</title>
    <link rel="stylesheet" href="./css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css"
    />
  </head>

  <body>
    <div id="nav"></div>
    <div class="main-container">
      <div id="carousel-container">
        <div
          id="carouselAutoPlay"
          class="carousel slide"
          data-bs-ride="carousel"
          data-interval="500"
        >
          <div class="carousel-inner">
            <div class="carousel-item active">
              <img src="images/book.webp" alt="image of books" />
            </div>
            <div class="carousel-item">
              <img src="images/books.webp" alt="image of books" />
            </div>
          </div>
        </div>
      </div>
      <div class="booklist">
        <div id="media-container"></div>
        <div class="view-selector">
          <label for="view-select">Choose a view:</label>
          <select id="view-select" onchange="changeView(this.value)">
            <option value="all_media">All Media View</option>
            <option value="books">Books View</option>
            <option value="user_media">User Media View</option>
          </select>
        </div>
        <script>
          async function loadMedia(filter = '') {
            try {
              console.log(`Loading media with filter: ${filter}`);
              const response = await fetch(`http://localhost:3000/media?filter=${filter}`);
              const data = await response.json();
              console.log('Data received:', data);
  
              if (!data.rows) {
                throw new Error('Invalid data format received');
              }
  
              const mediaContainer = document.getElementById('media-container');
              mediaContainer.innerHTML = ''; // Clear previous content
              data.rows.forEach(row => {
                const media = row.value;
                const mediaElement = document.createElement('div');
                mediaElement.className = 'media-item';
                mediaElement.innerHTML = `
                  <h3>${media.title}</h3>
                  <p>${media.description}</p>
                  <p>Quantity in stock: ${media.quantity}</p>
                  <img src="${media.url}" alt="${media.title}" />
                  <button class="borrow-button" onclick="borrowMedia('${row.id}')">Borrow Media</button>
                `;
                mediaContainer.appendChild(mediaElement);
              });
            } catch (error) {
              console.error('Error loading media:', error);
            }
          }
  
          async function loadUserMedia(userId) {
            try {
              console.log(`Loading user media for user ID: ${userId}`);
              const response = await fetch(`http://localhost:3000/user_media?user_id=${userId}`);
              const data = await response.json();
              console.log('User media data received:', data);
  
              if (!data.rows || data.rows.length === 0) {
                console.log('No media found for user.');
                alert('No media found for user.');
                return;
              }
  
              const mediaContainer = document.getElementById('media-container');
              mediaContainer.innerHTML = ''; // Clear previous content
              data.rows.forEach(row => {
                const media = row.value;
                const returnDate = new Date(media.return_date * 1000).toLocaleDateString();
                const mediaElement = document.createElement('div');
                mediaElement.className = 'media-item';
                mediaElement.innerHTML = `
                  <h3>${media.title}</h3>
                  <p>${media.description}</p>
                  <p>Return Date: ${returnDate}</p>
                  <img src="${media.url}" alt="${media.title}" />
                  <button class="return-button" onclick="returnMedia('${row.id}', '${userId}')">Return Media</button>
                `;
                mediaContainer.appendChild(mediaElement);
              });
            } catch (error) {
              console.error('Error loading user media:', error);
            }
          }
  
          async function returnMedia(mediaId, userId) {
            try {
              console.log(`Returning media ID: ${mediaId} for user ID: ${userId}`);
              const response = await fetch(`http://localhost:3000/return_media`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mediaId: mediaId, userId: userId })
              });
              const data = await response.json();
              console.log('Return media response:', data);
              if (data.success) {
                alert('Media returned successfully.');
                loadUserMedia(userId); // Reload user media
              } else {
                alert('Failed to return media.');
              }
            } catch (error) {
              console.error('Error returning media:', error);
              alert('Failed to return media.');
            }
          }
  
          async function borrowMedia(mediaId) {
            const email = prompt('Please enter your email:');
            if (email) {
              const userId = await getUserIdByEmail(email);
              if (userId) {
                try {
                  console.log(`Borrowing media ID: ${mediaId} for user ID: ${userId}`);
                  const response = await fetch(`http://localhost:3000/borrow_media`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mediaId: mediaId, userId: userId })
                  });
                  const data = await response.json();
                  console.log('Borrow media response:', data);
                  if (data.success) {
                    alert('Media borrowed successfully.');
                    loadMedia(''); // Reload media
                  } else {
                    alert('Failed to borrow media.');
                  }
                } catch (error) {
                  console.error('Error borrowing media:', error);
                  alert('Failed to borrow media.');
                }
              }
            }
          }
  
          async function getUserIdByEmail(email) {
            try {
              console.log(`Fetching user ID for email: ${email}`);
              const response = await fetch(`http://localhost:3000/get_user_id`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
              });
              const data = await response.json();
              console.log('User data received:', data);
              if (data.userId) {
                return data.userId;
              } else {
                throw new Error('User not found');
              }
            } catch (error) {
              console.error('Error fetching user ID:', error);
              alert('User not found. Please try again.');
              return null;
            }
          }
  
          async function changeView(view) {
            if (view === 'user_media') {
              const email = prompt('Please enter your email:');
              if (email) {
                const userId = await getUserIdByEmail(email);
                if (userId) {
                  loadUserMedia(userId);
                }
              }
            } else {
              loadMedia(view === 'all_media' ? '' : view);
            }
          }
  
          document.addEventListener('DOMContentLoaded', () => {
            loadMedia(''); // Load all media by default
          });
        </script>
      </div>
    </div>
  
    <a class="loginbtn" href="login.html" role="link">Login/Sign up Here to Enjoy all of amls facilities</a>
    <!-- make hidden when logged in (need roles implemented first) -->
  </body>
  </html>
  
  <script>
    $(function () {
      $("#nav").load("nav.html");
    });
  </script>