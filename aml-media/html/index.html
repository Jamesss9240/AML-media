<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AML Library</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
</head>

<body>
    <div id="nav"></div>

    <div class="container my-4">
        <div id="carousel-container" class="mb-4">
            <div id="carouselAutoPlay" class="carousel slide" data-bs-ride="carousel" data-interval="500">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="images/blog-1.jpg" class="d-block w-100" alt="image of books" />
                    </div>
                    <div class="carousel-item">
                        <img src="images/books.webp" class="d-block w-100" alt="image of books" />
                    </div>
                    <div class="carousel-item">
                      <img src="images/blog-3.jpg" class="d-block w-100" alt="image of books" />
                  </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselAutoPlay" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselAutoPlay" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <div class="booklist mb-4">
            <div id="media-container" class="row"></div>
            <div class="view-selector mb-3">
                <label for="view-select" class="form-label">Choose a view:</label>
                <select id="view-select" class="form-select" onchange="changeView(this.value)">
                    <option value="all_media">All Media View</option>
                    <option value="books">Books View</option>
                    <option value="user_media">User Media View</option>
                </select>
            </div>
        </div>

        <div class="icon-container text-center">
            <h3>Follow Us</h3>
            <a href="#" class="social-icon"><i class="fab fa-facebook-square"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-twitter-square"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-instagram-square"></i></a>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function () {
            $("#nav").load("nav.html");
        });

        function changeView(view) {
            // Your existing functionality to change views based on selection
            console.log("View changed to:", view);
            // Implement your logic to dynamically change the media displayed
        }
          async function loadMedia(filter = '') {
            try {
              console.log(`Loading media with filter: ${filter}`);
              const response = await fetch(`http://localhost:3000/media?filter=${filter}`);
              const data = await response.json();
              console.log('Data received:', data);
  
              if (!data.rows) {
                throw new Error('Invalid data format received');
              }
  
              const mediaContainer = document.getElementById('media-container');
              mediaContainer.innerHTML = ''; // Clear previous content
              data.rows.forEach(row => {
                const media = row.value;
                const mediaElement = document.createElement('div');
                mediaElement.className = 'media-item';
                mediaElement.innerHTML = `
                  <h3>${media.title}</h3>
                  <p>${media.description}</p>
                  <p>Quantity in stock: ${media.quantity}</p>
                  <img src="${media.url}" alt="${media.title}" />
                  <button class="borrow-button" onclick="borrowMedia('${row.id}')">Borrow Media</button>
                `;
                mediaContainer.appendChild(mediaElement);
              });
            } catch (error) {
              console.error('Error loading media:', error);
            }
          }
  
          async function loadUserMedia(userId) {
            try {
              console.log(`Loading user media for user ID: ${userId}`);
              const response = await fetch(`http://localhost:3000/user_media?user_id=${userId}`);
              const data = await response.json();
              console.log('User media data received:', data);
  
              if (!data.rows || data.rows.length === 0) {
                console.log('No media found for user.');
                alert('No media found for user.');
                return;
              }
  
              const mediaContainer = document.getElementById('media-container');
              mediaContainer.innerHTML = ''; // Clear previous content
              data.rows.forEach(row => {
                const media = row.value;
                const returnDate = new Date(media.return_date * 1000).toLocaleDateString();
                const mediaElement = document.createElement('div');
                mediaElement.className = 'media-item';
                mediaElement.innerHTML = `
                  <h3>${media.title}</h3>
                  <p>${media.description}</p>
                  <p>Return Date: ${returnDate}</p>
                  <img src="${media.url}" alt="${media.title}" />
                  <button class="return-button" onclick="returnMedia('${row.id}', '${userId}')">Return Media</button>
                `;
                mediaContainer.appendChild(mediaElement);
              });
            } catch (error) {
              console.error('Error loading user media:', error);
            }
          }
  
          async function returnMedia(mediaId, userId) {
            try {
              console.log(`Returning media ID: ${mediaId} for user ID: ${userId}`);
              const response = await fetch(`http://localhost:3000/return_media`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mediaId: mediaId, userId: userId })
              });
              const data = await response.json();
              console.log('Return media response:', data);
              if (data.success) {
                alert('Media returned successfully.');
                loadUserMedia(userId); // Reload user media
              } else {
                alert('Failed to return media.');
              }
            } catch (error) {
              console.error('Error returning media:', error);
              alert('Failed to return media.');
            }
          }
  
          async function borrowMedia(mediaId) {
            const email = prompt('Please enter your email:');
            if (email) {
              const userId = await getUserIdByEmail(email);
              if (userId) {
                try {
                  console.log(`Borrowing media ID: ${mediaId} for user ID: ${userId}`);
                  const response = await fetch(`http://localhost:3000/borrow_media`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mediaId: mediaId, userId: userId })
                  });
                  const data = await response.json();
                  console.log('Borrow media response:', data);
                  if (data.success) {
                    alert('Media borrowed successfully.');
                    loadMedia(''); // Reload media
                  } else {
                    alert('Failed to borrow media.');
                  }
                } catch (error) {
                  console.error('Error borrowing media:', error);
                  alert('Failed to borrow media.');
                }
              }
            }
          }
  
          async function getUserIdByEmail(email) {
            try {
              console.log(`Fetching user ID for email: ${email}`);
              const response = await fetch(`http://localhost:3000/get_user_id`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
              });
              const data = await response.json();
              console.log('User data received:', data);
              if (data.userId) {
                return data.userId;
              } else {
                throw new Error('User not found');
              }
            } catch (error) {
              console.error('Error fetching user ID:', error);
              alert('User not found. Please try again.');
              return null;
            }
          }
  
          async function changeView(view) {
            if (view === 'user_media') {
              const email = prompt('Please enter your email:');
              if (email) {
                const userId = await getUserIdByEmail(email);
                if (userId) {
                  loadUserMedia(userId);
                }
              }
            } else {
              loadMedia(view === 'all_media' ? '' : view);
            }
          }
  
          document.addEventListener('DOMContentLoaded', () => {
            loadMedia(''); // Load all media by default
          });
        </script>
      </div>
    </div>
  
    <a class="loginbtn" href="login.html" role="link">Login/Sign up Here to Enjoy all of amls facilities</a>
    <!-- make hidden when logged in (need roles implemented first) -->
  </body>
  </html>
  
  <script>
    $(function () {
      $("#nav").load("nav.html");
    });
  </script>